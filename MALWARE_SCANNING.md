# Malware Scanning for File Uploads

Comprehensive virus/malware scanning implementation using ClamAV with graceful fallback.

## Overview

- **Scanner**: ClamAV (industry-standard open-source antivirus)
- **Fallback**: Automatic fallback to heuristic validation when ClamAV unavailable
- **Integration**: Seamless middleware integration with file uploads
- **Features**: Real-time scanning, quarantine, content validation

## Quick Start

### 1. Install ClamAV

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install clamav clamav-daemon
sudo systemctl start clamav-daemon
sudo systemctl enable clamav-daemon
```

**macOS:**
```bash
brew install clamav
brew services start clamav
```

**Windows (WSL):**
```bash
wsl --install
# Then follow Ubuntu instructions
```

**Update virus definitions:**
```bash
sudo freshclam
```

### 2. Configure Environment

Add to `.env`:
```env
CLAMAV_HOST=localhost
CLAMAV_PORT=3310
```

### 3. Use in Routes

```javascript
import { uploadSingle, scanForMalware, validateFileContent } from '../middleware/fileUpload.js';

router.post('/upload',
  authenticate,
  uploadSingle('file'),      // 1. Upload file
  validateFileContent,        // 2. Validate content (magic bytes)
  scanForMalware,            // 3. Scan for malware
  handleUpload               // 4. Process clean file
);
```

## Features

### ✅ ClamAV Scanning
- Real-time virus/malware detection
- 8+ million virus signatures
- Automatic daemon connection
- Buffer and file scanning

### ✅ Fallback Validation
- Works without ClamAV
- File size limits
- Extension blocking
- MIME type verification
- Content pattern detection
- Magic bytes validation

### ✅ Security Features
- Infected file quarantine
- Automatic file deletion
- Extension mismatch detection
- Executable file blocking
- Security event logging
- SHA-256 file hashing

## API Usage

### Upload with Scanning

**Endpoint**: `POST /api/v1/upload`

```bash
curl -X POST http://localhost:5000/api/v1/upload \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@document.pdf"
```

**Success Response:**
```json
{
  "success": true,
  "message": "File uploaded successfully",
  "file": {
    "filename": "1697123456-abc123.pdf",
    "originalname": "document.pdf",
    "size": 524288,
    "path": "/uploads/safe/1697123456-abc123.pdf"
  },
  "scanResult": {
    "safe": true,
    "infected": false,
    "scanTime": 45,
    "scanner": "ClamAV"
  }
}
```

**Malware Detected:**
```json
{
  "success": false,
  "message": "Malware detected: Win.Test.EICAR_HDB-1",
  "scanResult": {
    "safe": false,
    "infected": true,
    "viruses": ["Win.Test.EICAR_HDB-1"],
    "scanner": "ClamAV",
    "action": "quarantined"
  }
}
```

## Middleware Configuration

### Basic Upload + Scan
```javascript
router.post('/upload',
  uploadSingle('file'),
  scanForMalware,
  (req, res) => {
    res.json({
      success: true,
      file: req.file,
      scanResult: req.scanResults[0]
    });
  }
);
```

### Multiple Files
```javascript
import { uploadMultiple } from '../middleware/fileUpload.js';

router.post('/upload-multiple',
  uploadMultiple('files', 5),  // Max 5 files
  scanForMalware,
  validateFileContent,
  handleMultipleFiles
);
```

### Custom File Types
```javascript
const uploadPDF = createUploadMiddleware({
  maxFileSize: 10 * 1024 * 1024,  // 10MB
  allowedTypes: ['application/pdf']
});

router.post('/upload-pdf',
  uploadPDF.single('document'),
  scanForMalware,
  handlePDF
);
```

## Configuration

### ClamAV Settings

**`src/services/malwareScanService.js`:**
```javascript
{
  clamdscan: {
    host: 'localhost',
    port: 3310,
    timeout: 60000,
    localFallback: true  // Try local scanner if daemon unavailable
  }
}
```

### Blocked Extensions

```javascript
const BLOCKED_EXTENSIONS = [
  '.exe', '.bat', '.cmd', '.com', '.scr',
  '.vbs', '.vbe', '.js', '.jse', '.wsf',
  '.wsh', '.msi', '.jar', '.app', '.deb',
  '.rpm', '.dmg', '.pkg', '.sh', '.bash'
];
```

### Allowed MIME Types

```javascript
const ALLOWED_MIME_TYPES = {
  images: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
  documents: [
    'application/pdf',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  ],
  archives: ['application/zip', 'application/x-rar-compressed']
};
```

## Quarantine Management

### View Quarantined Files

```bash
ls -lh quarantine/
```

### Restore False Positive

```bash
# Review file
file quarantine/1697123456-abc123-suspicious.pdf.quarantine

# Restore if safe
mv quarantine/1697123456-abc123-suspicious.pdf.quarantine uploads/safe/document.pdf
```

### Delete Quarantined Files

```bash
# After review, permanently delete
rm quarantine/*.quarantine
```

## Testing

### Test with EICAR

EICAR is a harmless test file that all antivirus software detects:

```bash
# Create EICAR test file
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt

# Upload test file
curl -X POST http://localhost:5000/api/v1/upload \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@eicar.txt"

# Expected: "Malware detected: Win.Test.EICAR_HDB-1"
```

## Troubleshooting

### ClamAV Not Running

**Check status:**
```bash
sudo systemctl status clamav-daemon
```

**Start daemon:**
```bash
sudo systemctl start clamav-daemon
```

**Check logs:**
```bash
sudo tail -f /var/log/clamav/clamav.log
```

### Definitions Out of Date

```bash
# Update virus definitions
sudo freshclam

# Restart daemon
sudo systemctl restart clamav-daemon
```

### Permission Errors

```bash
# Fix permissions
sudo chown -R clamav:clamav /var/lib/clamav
sudo chmod 755 /var/run/clamav
```

### Port Already in Use

```bash
# Check what's using port 3310
sudo netstat -tlnp | grep 3310

# Change port in /etc/clamav/clamd.conf
TCPSocket 3311
```

## Performance

### Scan Times

| File Size | Scan Time | Notes |
|-----------|-----------|-------|
| 1KB | <10ms | Text files |
| 100KB | ~20ms | Images |
| 1MB | ~50ms | Documents |
| 10MB | ~200ms | Large files |
| 100MB | ~2s | Archives |

### Optimization

1. **Use ClamAV Daemon**: Faster than command-line (no startup time)
2. **Update Definitions**: Keep virus definitions current
3. **Async Scanning**: Process uploads in background queue
4. **File Size Limits**: Reject very large files early
5. **Extension Filtering**: Block dangerous extensions before scanning

## Production Deployment

### Docker

```dockerfile
# Install ClamAV in Docker
RUN apt-get update && apt-get install -y clamav clamav-daemon
RUN freshclam
CMD ["clamd"] && node src/app.js
```

### Kubernetes

```yaml
# ClamAV sidecar container
- name: clamav
  image: clamav/clamav:latest
  ports:
    - containerPort: 3310
```

### AWS

Use AWS Lambda Layers with ClamAV or Amazon Inspector.

## Security Best Practices

1. ✅ Always scan uploads before processing
2. ✅ Quarantine infected files, don't delete immediately
3. ✅ Log all scan results for audit
4. ✅ Update virus definitions daily
5. ✅ Validate file content (magic bytes)
6. ✅ Block executable file types
7. ✅ Implement file size limits
8. ✅ Use HTTPS for uploads
9. ✅ Require authentication
10. ✅ Monitor quarantine directory

## Resources

- [ClamAV Official Docs](https://docs.clamav.net/)
- [ClamAV GitHub](https://github.com/Cisco-Talos/clamav)
- [Node-ClamScan](https://github.com/kylefarris/clamscan)
- [EICAR Test File](https://www.eicar.org/)

---

**Last Updated**: October 2024
**ClamAV Version**: 1.0+
**Node Package**: clamscan ^2.4.0
